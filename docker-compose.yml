version: '3.8'

services:
  # ============================================
  # POSTGRESQL DATABASE
  # ============================================
  # OPCION 1: Usar PostgreSQL existente de Easypanel (RECOMENDADO)
  # - Comenta este servicio 'db'
  # - Usa DATABASE_URL con el hostname: deep-data_db_appgastos
  # - Configura en variables de entorno de Easypanel
  #
  # OPCION 2: PostgreSQL local (solo para testing local)
  # - Descomenta este servicio
  # - Ãštil para probar con docker-compose en tu PC

  # db:
  #   image: postgres:15-alpine
  #   container_name: app_gastos_db
  #   environment:
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
  #     POSTGRES_DB: app_gastos
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   networks:
  #     - app_network
  #   restart: unless-stopped

  # ============================================
  # BACKEND - FastAPI
  # ============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: app_gastos_backend
    environment:
      # Para Easypanel con PostgreSQL existente, configurar en variables de entorno:
      # DATABASE_URL=postgresql://postgres:PASSWORD@deep-data_db_appgastos:5432/app_gastos
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:changeme@db:5432/app_gastos}
      SECRET_KEY: ${SECRET_KEY:-dev-secret-change-in-production}
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
      ENVIRONMENT: ${ENVIRONMENT:-production}
    ports:
      - "8000:8000"
    # Quitar depends_on si no usas el servicio db local
    # depends_on:
    #   - db
    networks:
      - app_network
    restart: unless-stopped

  # ============================================
  # FRONTEND - React + Nginx
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:8000/api}
    container_name: app_gastos_frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - app_network
    restart: unless-stopped

# Solo necesario si usas PostgreSQL local (servicio db descomentado)
# volumes:
#   postgres_data:

networks:
  app_network:
    driver: bridge
